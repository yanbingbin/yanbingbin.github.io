## 网页加载流程

### URL解析

解析 `URL` 提取出协议、域名、端口号，对于一些特殊字符，在传递的时候需要进行编码解码。
- `encodeURI`、`decodeURI`可以对中文、空格等编码解码，适用于 `URL` 本身
- `encodeURIComponent`、`decodeURIComponent`范围更广，会编码解码一些特殊字符如 `:/?=+@#$`,适用于给参数编码解码

### 缓存检查

依次查找 `Memory Cache`、`Disk Cache`中是否有缓存内容，有且没过期则使用，否则则发送网络请求。

### DNS 解析

> 什么是 `DNS` 解析，每台计算机的唯一标识是 `IP` 地址，但是 `IP` 地址不方便记忆，所以采用更方便记忆的网址去查找其他计算机，将网址转换成 `IP` 地址的过程就是 `DNS` 解析。

域名解析是一个递归查询的过程。
1. 浏览器缓存，向浏览器的缓存中读取上一次的访问记录
2. 操作系统的缓存，查找存储在系统运行内存中的缓存
3. 在 `host` 文件中查找
4. 路由器缓存：有些路由器会把访问过的域名存在路由器上
5. `ISP`互联网服务提供商缓存，比如 `114.114.114.114`，
6. 缓存中找不到，则进行迭代查询：`.` 根 `DNS` 服务器 -> `.com` 顶级服务器 -> 主域名服务器 -> ...，直到服务器返回对应的 `IP`

`DNS` 负载均衡：
> 网站对应的 `IP` 不止一个，`DNS` 可以根据每台机器的负载量、距离用户的距离等返回一个合适的服务器 `IP` 给用户，这个过程就是 `DNS` 负载均衡，又叫做 `DNS` 重定向。 `CDN` 就是利用 `DNS` 的重定向技术， `DNS` 会返回一个用户最接近的点的 `IP` 给用户。

优化： `DNS` 预解析, 通过 `dns-prefetch` 属性提前进行 `DNS` 解析。

```js
<link rel="dns-prefetch" href="//g.alicdn.com" />  
```

### TCP 连接三次握手

拿到 `IP` 后，(检查当前域名是否达到 `TCP` 连接上限)，通过三次握手进行 `TCP` 连接


![](https://user-gold-cdn.xitu.io/2020/2/23/170723de9b8aa08b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

三次握手：
1. 第一次：客户端发送 `SYN` 包和初始序号 `seq = x`  给服务端，此时客户端状态为 `SYN-SENT`
2. 第二次：服务端收到 `SYN` 包后，将标识位 `SYN` 和 `ACK` 置为1，确认序号 `ack = x + 1`, 初始序号 `seq = y` 发送给客户端，此时服务端状态为 `SYN-RECEIVED`
3. 第三次：客户端收到后，将标识位 `ACK` 置为1, 确认序号 `ack = y + 1`, 自己的序号 `seq = x + 1`, 发送给服务端，服务端收到后也将状态切换为 `ESTABLISHED`


三次握手抽象版：
1. 客户端：你是客户端吗
2. 服务端：是的，我是服务端，你是客户端吗
3. 客户端：是的，我是客户端

标识位：
- `ACK`：确认标识，用于表示对数据包的成功接收。
- `SYN`：同步标识，表示 `TCP` 连接已初始化，请求连接。
- `FIN`：完成标识，用于拆除上一个 `SYN` 标识。一个完整的TCP连接过程一定会有 `SYN` 和 `FIN` 包。

为什么不能两次握手：两次握手，服务器不能确定客户端已经收到了确认请求，不能确认是否建立好了连接。服务器认为建立好了连接，发送数据包，结果发的包客户端没收到，那么攻击服务器就很容易了，只发包不收包。

`TCP` 和 `UDP` 的区别：
- `TCP` 是一个面向连接的、可靠的、基于字节流的传输层协议，`TCP` 会精准记录哪些数据发送了，哪些数据被对方接收了，哪些没有被接收到，而且保证数据包按序到达，不允许半点差错。这是`有状态`, 当意识到丢包了或者网络环境不佳，`TCP` 会根据具体情况调整自己的行为，控制自己的发送速度或者重发。这是`可控制`。
- `UDP` 是一个面向无连接的传输层协议，`无状态`、`不可控`。

### HTTP请求

TCP 连接建立之后，浏览器端会构建请求行、 请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息。如果是 `HTTPS`，还需要进行 `TSL` 协商。

服务器检查 `HTTP` 请求头是否包含缓存验证信息进行`协商缓存`：

`Last-Modified` 和 `If-Modified-Since`：
> `Last_Modified` 表示本地文件的最后修改时间，`If-Modified-Since` 会将 `Last-Modified` 的值发送给服务器询问该资源是否有更新，如果有更新就会将新的资源发送回来，否则返回 `304` 状态码，代表资源无更新，继续使用缓存文件。

`Last-Modified` 弊端：
1. 如果文件只是被打开，没有修改，也会造成 `Last-Modified` 修改，服务器不能命中缓存。
2. 只能以秒计时，如果在毫秒级的时间内修改了文件，服务器 `Last-Modified` 的值并不会修改，会返回`304`，浏览器就会是自己的缓存 。

`ETag` 和 `If-No-Match`
> `ETag` 是文件指纹，`If-No-Match` 会将 `ETag` 发送给服务器，查询该资源 `ETag` 是否变动，有变动的话就将新的资源发送回来。`ETag` 优先级高于 `Last-Modified`。

启发式缓存：如果什么缓存都没设置，浏览器通常会响应头中的 `Date` 减去 `Last-Modified` 值的 10% 作为缓存时间。
### 四次挥手

数据传输完后，如果请求头或响应头里没有 `connection: keep-alive`，则需要四次挥手断开 `TCP` 连接，否则会保持连接通道，这样下一次在发送请求，就无需再次TCP三次握手了，节省了网络通信时间。

> `http1.0` 中默认 `Connection` 并不是 `keep-alive`，需要手动处理，但是 `HTTP1.1` 之后，`Connection：keep-alive` 已经被列入了规范，现在基本都是默认就是长连接，前提是同一个源，向不同源发送请求要重新建立通道。

四次挥手：
- 第一次：客户端主动关闭放发送一个 `FIN`，用来关闭客户端到服务端的数据传输，告诉服务端我不会给你发送数据了
- 第二次：服务端收到 `FIN` 包后，发送一个 `ACK` 给客户端，确认序号为收到序号 + 1
- 第三次：服务端发送完数据后，服务端发送一个 `FIN`，用来关闭服务端到客户端的数据传输，告诉客户端我不会给你发数据了
- 第四次：客户端收到 `FIN` 后，发送一个 `ACK` 给服务端，确认序号为收到序号 + 1，完成四次挥手

四次挥手抽象版：
1. 客户端：服务端，我要和你断开连接
2. 服务端：好的，断吧
3. 服务端：我也要和你断开连接
4. 客户端：好的，断吧

四次握手后，客户端还会等待 `2MSL`（MSL:最长报文段寿命，一般2min） 的时间，为了保证客户端发送的 `ACK` 报文能够到达服务器，因为这个报文可能会丢失，服务器收不到确认会超时重传 `FIN` + `ACK`
报文段，客户端能在 `2MSL` 时间内收到这个重传的报文段，然后客户端重新确认。

### 客户端解析资源

- 浏览器拿到资源会根据资源类型进行处理，比如是 `gzip` 压缩后的文件则进行解压缩，如果响应头 `Content-type` 为 `text/html`，则开始解析 `HTML`
`HTML Parser` 对 `HTML` 文件进行词法分析和语法分析，根据 `HTML` 标记关系构建 `DOM` 树。
- 解析过程中遇到图片、`link`、`script`会启动下载。
1. `script`标签会阻塞 `DOM` 树的构建，所以一般将 `script` 放在底部，或者添加 `async` 、`defer` 标识。
2. `css` 下载时异步，不会阻塞浏览器构建 `DOM` 树，但是会阻塞渲染，在构建 `render` 时，会等待 `css` 下载解析完毕后才进行。
- `CSS Parser` 解析层叠样式表构建 `CSSOM` 树。
- 根据 `DOM` 树和 `CSSOM` 树构建 `render` 树，`display: none`不可见节点以及 `head` 这种不可见标签不会插入到渲染树里
- `render` 树构建完成后，浏览器开始布局 `render` 树并将其绘制到屏幕上
- `HTML` 解析过程会逐步显示页面

> `async` 和 `defer` 虽然都是异步的，不过还有一些差异，使用 `async` 标志的脚本文件一旦加载完成，会立即执行；而使用了 `defer` 标记的脚本文件，需要在 `DOMContentLoaded` 事件之前执行。

<!-- ## 优化

- `dns` 解析优化：预解析，`dns` 缓存 -->


## 参考文章

- ![阿里面试官的”说一下从url输入到返回请求的过程“问的难度就是不一样！](https://juejin.cn/post/6928677404332425223)
- ![从输入URL到页面加载的过程？如何由一道题完善自己的前端知识体系！](https://dailc.github.io/2018/03/12/whenyouenteraurl.html)
- ![(建议收藏)TCP协议灵魂之问，巩固你的网路底层基础](https://juejin.cn/post/6844904070889603085#heading-1)